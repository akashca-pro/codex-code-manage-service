services:
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka-local
    hostname: kafka # 'kafka' will resolve to this container
    ports:
      # Map port 9092 for your local apps
      - "9092:9092"
      # We also need to map 9093 for the controller
      - "9093:9093"
    # These resource limits are from your K8s Deployment
    mem_limit: 1g
    cpus: '1.0'
    
    # This command block is copied directly from your K8s file,
    # with the advertised.listeners changed for localhost.
    command:
      - /bin/sh
      - -c
      - |
        set -e
        # 1. Create the properties file
        cat <<EOF > /opt/kafka/config/kraft/server.properties
        process.roles=broker,controller
        node.id=1
        
        # Use the hostname 'kafka' for the voter
        controller.quorum.voters=1@kafka:9093 
        controller.listener.names=CONTROLLER

        # Listen on all interfaces in the container
        listeners=INTERNAL://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
        
        # *** THIS IS THE FIX FOR LOCALHOST ***
        # Advertise 'localhost:9092' to your services
        advertised.listeners=INTERNAL://localhost:9092
        
        listener.security.protocol.map=INTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
        inter.broker.listener.name=INTERNAL

        num.partitions=3
        offsets.topic.replication.factor=1
        transaction.state.log.replication.factor=1
        transaction.state.log.min.isr=1

        log.dirs=/tmp/kraft-combined-logs
        EOF

        # 2. Format storage (this will re-format every time, destroying old data)
        echo "Formatting storage..."
        /opt/kafka/bin/kafka-storage.sh format \
          --ignore-formatted \
          --cluster-id=$(/opt/kafka/bin/kafka-storage.sh random-uuid) \
          --config /opt/kafka/config/kraft/server.properties

        # 3. Start Kafka
        echo "Starting Kafka..."
        exec /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft/server.properties

